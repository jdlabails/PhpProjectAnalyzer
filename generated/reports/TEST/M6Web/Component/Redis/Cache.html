<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<meta http-equiv="Content-Language" content="en" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Projet Redis : code coverage of M6Web\Component\Redis\Cache</title>
		<link rel="stylesheet" media="screen" type="text/css" href="../../../screen.css" title="Screen" />
	</head>
	<body>
		<div id="header">
			<h1>Code coverage of <a href="../../../index.html">Projet Redis</a>: M6Web\Component\Redis\Cache</h1>
			<h2>Class code coverage <span>88.18%</span></h2>
		</div>
		<div id="page">
			<div id="content">
				<h3>Methods</h3>
				<ul class="summary">
					
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 83.33%"></div>
										<div class="label">
											<span class="percent">83.33%</span>
											<a href="#__construct">__construct</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#setNamespace">setNamespace</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 0%"></div>
										<div class="label">
											<span class="percent">0%</span>
											<a href="#getNamespace">getNamespace</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#get">get</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#del">del</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#set">set</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#exists">exists</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#type">type</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#ttl">ttl</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 86.67%"></div>
										<div class="label">
											<span class="percent">86.67%</span>
											<a href="#incr">incr</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 12.5%"></div>
										<div class="label">
											<span class="percent">12.5%</span>
											<a href="#expire">expire</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#getPatternKey">getPatternKey</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#flush">flush</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#watch">watch</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#unwatch">unwatch</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#multi">multi</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 94.74%"></div>
										<div class="label">
											<span class="percent">94.74%</span>
											<a href="#exec">exec</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#discard">discard</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#getAllKeys">getAllKeys</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#keys">keys</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#runOnAllRedisServer">runOnAllRedisServer</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 81.82%"></div>
										<div class="label">
											<span class="percent">81.82%</span>
											<a href="#dbSize">dbSize</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 81.82%"></div>
										<div class="label">
											<span class="percent">81.82%</span>
											<a href="#info">info</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 0%"></div>
										<div class="label">
											<span class="percent">0%</span>
											<a href="#setCurrentDb">setCurrentDb</a>
										</div>
									</div>
								
							</li>
						
							<li>
								
								
									<div class="bar">
										<div class="background"></div>
										<div class="graph" style="width: 100%"></div>
										<div class="label">
											<span class="percent">100%</span>
											<a href="#addToExecList">addToExecList</a>
										</div>
									</div>
								
							</li>
						
					
				</ul>
				<h3>Source</h3>
				<table cellpadding="0" cellspacing="0" class="source">
					<tr><th class="number">Line</th><th>Code</th></tr>
					<tr><td class="number">1</td><td><pre>&lt;?php
</pre></td></tr><tr><td class="number">2</td><td><pre>/**
</pre></td></tr><tr><td class="number">3</td><td><pre> * implement Redis for a cache
</pre></td></tr><tr><td class="number">4</td><td><pre> *
</pre></td></tr><tr><td class="number">5</td><td><pre> * class dealing only with set and get and propose a build-in namespace feature
</pre></td></tr><tr><td class="number">6</td><td><pre> * you can have multiple redis server (see manager)
</pre></td></tr><tr><td class="number">7</td><td><pre> *
</pre></td></tr><tr><td class="number">8</td><td><pre> * @author Olivier Mansour
</pre></td></tr><tr><td class="number">9</td><td><pre> */
</pre></td></tr><tr><td class="number">10</td><td><pre>namespace M6Web\Component\Redis;
</pre></td></tr><tr><td class="number">11</td><td><pre>
</pre></td></tr><tr><td class="number">12</td><td><pre>use Predis;
</pre></td></tr><tr><td class="number">13</td><td><pre>
</pre></td></tr><tr><td class="number">14</td><td><pre>/**
</pre></td></tr><tr><td class="number">15</td><td><pre> * class specialized for a cache usage
</pre></td></tr><tr><td class="number">16</td><td><pre> * you cant access here to the predis base object
</pre></td></tr><tr><td class="number">17</td><td><pre> */
</pre></td></tr><tr><td class="number">18</td><td><pre>class Cache extends Manager
</pre></td></tr><tr><td class="number">19</td><td><pre>{
</pre></td></tr><tr><td class="number">20</td><td><pre>    const CACHE = 0; // dbname will always be 0
</pre></td></tr><tr><td class="number">21</td><td><pre>
</pre></td></tr><tr><td class="number">22</td><td><pre>    /**
</pre></td></tr><tr><td class="number">23</td><td><pre>     * namespace used to prefix keys
</pre></td></tr><tr><td class="number">24</td><td><pre>     * @var string
</pre></td></tr><tr><td class="number">25</td><td><pre>     */
</pre></td></tr><tr><td class="number">26</td><td><pre>    protected $namespace = null;
</pre></td></tr><tr><td class="number">27</td><td><pre>
</pre></td></tr><tr><td class="number">28</td><td><pre>    /**
</pre></td></tr><tr><td class="number">29</td><td><pre>     * using the multi feature (see redis.io) we will store set and get since exec is called
</pre></td></tr><tr><td class="number">30</td><td><pre>     * when exec is called, set and get are dispatched between servers during multiple transactions
</pre></td></tr><tr><td class="number">31</td><td><pre>     * @var boolean
</pre></td></tr><tr><td class="number">32</td><td><pre>     */
</pre></td></tr><tr><td class="number">33</td><td><pre>    protected $multi = false;
</pre></td></tr><tr><td class="number">34</td><td><pre>
</pre></td></tr><tr><td class="number">35</td><td><pre>    /**
</pre></td></tr><tr><td class="number">36</td><td><pre>     * list of closures executed in multi mode
</pre></td></tr><tr><td class="number">37</td><td><pre>     * @var array
</pre></td></tr><tr><td class="number">38</td><td><pre>     */
</pre></td></tr><tr><td class="number">39</td><td><pre>    protected $execList = array();
</pre></td></tr><tr><td class="number">40</td><td><pre>
</pre></td></tr><tr><td class="number">41</td><td><pre>    /**
</pre></td></tr><tr><td class="number">42</td><td><pre>     * class constructor
</pre></td></tr><tr><td class="number">43</td><td><pre>     * @param array $params Manager parameters
</pre></td></tr><tr><td class="number">44</td><td><pre>     *
</pre></td></tr><tr><td class="number">45</td><td><pre>     * @throws Exception
</pre></td></tr><tr><td class="number">46</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="__construct"></a>47</td><td><pre>    public function __construct($params)
</pre></td></tr><tr><td class="number"><a name="__construct"></a>48</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">49</td><td><pre>        if (!isset($params[&#039;namespace&#039;])) {
</pre></td></tr><tr class="notCovered"><td class="number">50</td><td><pre>            throw new Exception(&quot;Le parametre namespace est obligatoire&quot;);
</pre></td></tr><tr><td class="number"><a name="__construct"></a>51</td><td><pre>        }
</pre></td></tr><tr class="covered"><td class="number">52</td><td><pre>        $this-&gt;setNamespace($params[&#039;namespace&#039;]);
</pre></td></tr><tr class="covered"><td class="number">53</td><td><pre>        parent::__construct($params);
</pre></td></tr><tr class="covered"><td class="number">54</td><td><pre>        $this-&gt;currentDb = self::CACHE;
</pre></td></tr><tr class="covered"><td class="number">55</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="__construct"></a>56</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="__construct"></a>57</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="__construct"></a>58</td><td><pre>     * set the namespace
</pre></td></tr><tr><td class="number"><a name="__construct"></a>59</td><td><pre>     * @param string $v namespace (sort of)
</pre></td></tr><tr><td class="number"><a name="__construct"></a>60</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="setNamespace"></a>61</td><td><pre>    public function setNamespace($v)
</pre></td></tr><tr><td class="number"><a name="setNamespace"></a>62</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">63</td><td><pre>        $this-&gt;namespace =  str_replace(array(&#039;\\&#039;, &#039;?&#039;, &#039;*&#039;, &#039;[&#039;, &#039;]&#039;, &#039;:&#039;), &#039;&#039;, (string) $v).&#039;/&#039;;
</pre></td></tr><tr class="covered"><td class="number">64</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="setNamespace"></a>65</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="setNamespace"></a>66</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="setNamespace"></a>67</td><td><pre>     * get the namespace
</pre></td></tr><tr><td class="number"><a name="setNamespace"></a>68</td><td><pre>     * @return string
</pre></td></tr><tr><td class="number"><a name="setNamespace"></a>69</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>70</td><td><pre>    public function getNamespace()
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>71</td><td><pre>    {
</pre></td></tr><tr class="notCovered"><td class="number">72</td><td><pre>        return $this-&gt;namespace;
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>73</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>74</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>75</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>76</td><td><pre>     * get a value from the cache
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>77</td><td><pre>     * @param string $key cl&eacute;
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>78</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>79</td><td><pre>     * @return mixed|null Null if no value available
</pre></td></tr><tr><td class="number"><a name="getNamespace"></a>80</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="get"></a>81</td><td><pre>    public function get($key)
</pre></td></tr><tr><td class="number"><a name="get"></a>82</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">83</td><td><pre>        $redis = $this-&gt;getRedis($key);
</pre></td></tr><tr class="covered"><td class="number">84</td><td><pre>        $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">85</td><td><pre>        $ret = $redis-&gt;get($this-&gt;getPatternKey().$key); // ajout du pattern
</pre></td></tr><tr class="covered"><td class="number">86</td><td><pre>        $this-&gt;notifyEvent(&#039;get&#039;, array($this-&gt;getPatternKey().$key), microtime(true) - $start);
</pre></td></tr><tr class="covered"><td class="number">87</td><td><pre>        if ($ret and $this-&gt;getCompress()) {
</pre></td></tr><tr class="covered"><td class="number">88</td><td><pre>            return self::uncompress($ret);
</pre></td></tr><tr><td class="number"><a name="get"></a>89</td><td><pre>        } else {
</pre></td></tr><tr class="covered"><td class="number">90</td><td><pre>            return $ret;
</pre></td></tr><tr><td class="number"><a name="get"></a>91</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="get"></a>92</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="get"></a>93</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="get"></a>94</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="get"></a>95</td><td><pre>     * delete a key
</pre></td></tr><tr><td class="number"><a name="get"></a>96</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="get"></a>97</td><td><pre>     * @param array $keys array of keys
</pre></td></tr><tr><td class="number"><a name="get"></a>98</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="get"></a>99</td><td><pre>     * @return integer
</pre></td></tr><tr><td class="number"><a name="get"></a>100</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="del"></a>101</td><td><pre>    public function del($keys)
</pre></td></tr><tr><td class="number"><a name="del"></a>102</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">103</td><td><pre>        if (!is_array($keys)) {
</pre></td></tr><tr class="covered"><td class="number">104</td><td><pre>            $keys = array($keys);
</pre></td></tr><tr class="covered"><td class="number">105</td><td><pre>        }
</pre></td></tr><tr class="covered"><td class="number">106</td><td><pre>        $funcs = array();
</pre></td></tr><tr><td class="number"><a name="del"></a>107</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="del"></a>108</td><td><pre>        // s&eacute;paration en serveur
</pre></td></tr><tr class="covered"><td class="number">109</td><td><pre>        foreach ($keys as $key) {
</pre></td></tr><tr class="covered"><td class="number">110</td><td><pre>            $keyP = $this-&gt;getPatternKey().$key;
</pre></td></tr><tr class="covered"><td class="number">111</td><td><pre>            $funcs[$key] = function ($redis) use ($keyP) {
</pre></td></tr><tr class="covered"><td class="number">112</td><td><pre>                $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">113</td><td><pre>                $count = $redis-&gt;del($keyP);
</pre></td></tr><tr class="covered"><td class="number">114</td><td><pre>                if ((is_int($count)) and ($count &gt; 0)) {
</pre></td></tr><tr class="covered"><td class="number">115</td><td><pre>                    $this-&gt;notifyEvent(&#039;del&#039;, array($keyP), microtime(true) - $start);
</pre></td></tr><tr class="covered"><td class="number">116</td><td><pre>                }
</pre></td></tr><tr><td class="number"><a name="del"></a>117</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">118</td><td><pre>                return $count;
</pre></td></tr><tr><td class="number"><a name="del"></a>119</td><td><pre>            };
</pre></td></tr><tr class="covered"><td class="number">120</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="del"></a>121</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">122</td><td><pre>        if (true === $this-&gt;multi) {
</pre></td></tr><tr><td class="number"><a name="del"></a>123</td><td><pre>            //throw new Exception(&quot;not implemented yet&quot;);
</pre></td></tr><tr class="covered"><td class="number">124</td><td><pre>            foreach ($funcs as $k =&gt; $func) {
</pre></td></tr><tr class="covered"><td class="number">125</td><td><pre>                $this-&gt;addToExecList($k, $func);
</pre></td></tr><tr class="covered"><td class="number">126</td><td><pre>            }
</pre></td></tr><tr><td class="number"><a name="del"></a>127</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">128</td><td><pre>            return $this;
</pre></td></tr><tr><td class="number"><a name="del"></a>129</td><td><pre>        } else {
</pre></td></tr><tr class="covered"><td class="number">130</td><td><pre>            $ret = 0;
</pre></td></tr><tr class="covered"><td class="number">131</td><td><pre>            foreach ($funcs as $k =&gt; $func) {
</pre></td></tr><tr class="covered"><td class="number">132</td><td><pre>                $ret += $func($this-&gt;getRedis($k)); // execution
</pre></td></tr><tr class="covered"><td class="number">133</td><td><pre>            }
</pre></td></tr><tr><td class="number"><a name="del"></a>134</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">135</td><td><pre>            return $ret;
</pre></td></tr><tr><td class="number"><a name="del"></a>136</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="del"></a>137</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="del"></a>138</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="del"></a>139</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="del"></a>140</td><td><pre>     * set a value
</pre></td></tr><tr><td class="number"><a name="del"></a>141</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="del"></a>142</td><td><pre>     * @param string  $key   la cl&eacute;
</pre></td></tr><tr><td class="number"><a name="del"></a>143</td><td><pre>     * @param string  $value valeur
</pre></td></tr><tr><td class="number"><a name="del"></a>144</td><td><pre>     * @param integer $ttl   time to live
</pre></td></tr><tr><td class="number"><a name="del"></a>145</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="del"></a>146</td><td><pre>     * @return Cache
</pre></td></tr><tr><td class="number"><a name="del"></a>147</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="set"></a>148</td><td><pre>    public function set($key, $value, $ttl = null)
</pre></td></tr><tr><td class="number"><a name="set"></a>149</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">150</td><td><pre>        if ($this-&gt;getCompress()) {
</pre></td></tr><tr class="covered"><td class="number">151</td><td><pre>            $value = self::compress($value);
</pre></td></tr><tr class="covered"><td class="number">152</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="set"></a>153</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">154</td><td><pre>        $keyP = $this-&gt;getPatternKey().$key;
</pre></td></tr><tr><td class="number"><a name="set"></a>155</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">156</td><td><pre>        if (is_null($ttl)) {
</pre></td></tr><tr class="covered"><td class="number">157</td><td><pre>            $func = function ($redis) use ($keyP, $value) {
</pre></td></tr><tr class="covered"><td class="number">158</td><td><pre>                $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">159</td><td><pre>                $redis-&gt;set($keyP, $value);
</pre></td></tr><tr class="covered"><td class="number">160</td><td><pre>                $this-&gt;notifyEvent(&#039;set&#039;, array($keyP, $value), microtime(true) - $start);
</pre></td></tr><tr><td class="number"><a name="set"></a>161</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">162</td><td><pre>                return $redis;
</pre></td></tr><tr class="covered"><td class="number">163</td><td><pre>            };
</pre></td></tr><tr class="covered"><td class="number">164</td><td><pre>        } else {
</pre></td></tr><tr class="covered"><td class="number">165</td><td><pre>            $func = function ($redis) use ($keyP, $value, $ttl) {
</pre></td></tr><tr class="covered"><td class="number">166</td><td><pre>                $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">167</td><td><pre>                $redis-&gt;setex($keyP, $ttl, $value);
</pre></td></tr><tr class="covered"><td class="number">168</td><td><pre>                $this-&gt;notifyEvent(&#039;setex&#039;, array($keyP, $ttl, $value), microtime(true) - $start);
</pre></td></tr><tr><td class="number"><a name="set"></a>169</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">170</td><td><pre>                return $redis;
</pre></td></tr><tr class="covered"><td class="number">171</td><td><pre>            };
</pre></td></tr><tr><td class="number"><a name="set"></a>172</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="set"></a>173</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">174</td><td><pre>        if (true === $this-&gt;multi) {
</pre></td></tr><tr class="covered"><td class="number">175</td><td><pre>            $this-&gt;addToExecList($key, $func);
</pre></td></tr><tr class="covered"><td class="number">176</td><td><pre>        } else {
</pre></td></tr><tr class="covered"><td class="number">177</td><td><pre>            $func($this-&gt;getRedis($key)); // set &quot;normal&quot;
</pre></td></tr><tr><td class="number"><a name="set"></a>178</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="set"></a>179</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">180</td><td><pre>        return $this;
</pre></td></tr><tr><td class="number"><a name="set"></a>181</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="set"></a>182</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="set"></a>183</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="set"></a>184</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="set"></a>185</td><td><pre>     * check if a key exist
</pre></td></tr><tr><td class="number"><a name="set"></a>186</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="set"></a>187</td><td><pre>     * @param string $key cl&eacute;
</pre></td></tr><tr><td class="number"><a name="set"></a>188</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="set"></a>189</td><td><pre>     * @return boolean
</pre></td></tr><tr><td class="number"><a name="set"></a>190</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="exists"></a>191</td><td><pre>    public function exists($key)
</pre></td></tr><tr><td class="number"><a name="exists"></a>192</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">193</td><td><pre>        $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">194</td><td><pre>        $ret = $this-&gt;getRedis($key)-&gt;exists($this-&gt;getPatternKey().$key);
</pre></td></tr><tr class="covered"><td class="number">195</td><td><pre>        $this-&gt;notifyEvent(&#039;exists&#039;, array($this-&gt;getPatternKey().$key), microtime(true) - $start);
</pre></td></tr><tr><td class="number"><a name="exists"></a>196</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">197</td><td><pre>        return $ret;
</pre></td></tr><tr><td class="number"><a name="exists"></a>198</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="exists"></a>199</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="exists"></a>200</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="exists"></a>201</td><td><pre>     * return the type of a key
</pre></td></tr><tr><td class="number"><a name="exists"></a>202</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="exists"></a>203</td><td><pre>     * @param string $key cl&eacute;
</pre></td></tr><tr><td class="number"><a name="exists"></a>204</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="exists"></a>205</td><td><pre>     * @return mixed
</pre></td></tr><tr><td class="number"><a name="exists"></a>206</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="type"></a>207</td><td><pre>    public function type($key)
</pre></td></tr><tr><td class="number"><a name="type"></a>208</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">209</td><td><pre>        $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">210</td><td><pre>        $ret = (string)$this-&gt;getRedis($key)-&gt;type($this-&gt;getPatternKey().$key);
</pre></td></tr><tr class="covered"><td class="number">211</td><td><pre>        $this-&gt;notifyEvent(&#039;type&#039;, array($this-&gt;getPatternKey().$key), microtime(true) - $start);
</pre></td></tr><tr><td class="number"><a name="type"></a>212</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">213</td><td><pre>        return $ret;
</pre></td></tr><tr><td class="number"><a name="type"></a>214</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="type"></a>215</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="type"></a>216</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="type"></a>217</td><td><pre>     * return a key ttl
</pre></td></tr><tr><td class="number"><a name="type"></a>218</td><td><pre>     * @param string $key cl&eacute;
</pre></td></tr><tr><td class="number"><a name="type"></a>219</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="type"></a>220</td><td><pre>     * @return integer
</pre></td></tr><tr><td class="number"><a name="type"></a>221</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="ttl"></a>222</td><td><pre>    public function ttl($key)
</pre></td></tr><tr><td class="number"><a name="ttl"></a>223</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">224</td><td><pre>        $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">225</td><td><pre>        $ret = $this-&gt;getRedis($key)-&gt;ttl($this-&gt;getPatternKey().$key);
</pre></td></tr><tr class="covered"><td class="number">226</td><td><pre>        $this-&gt;notifyEvent(&#039;ttl&#039;, array($this-&gt;getPatternKey().$key), microtime(true) - $start);
</pre></td></tr><tr><td class="number"><a name="ttl"></a>227</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">228</td><td><pre>        return $ret;
</pre></td></tr><tr><td class="number"><a name="ttl"></a>229</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="ttl"></a>230</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="ttl"></a>231</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="ttl"></a>232</td><td><pre>     * increment a value (incr)
</pre></td></tr><tr><td class="number"><a name="ttl"></a>233</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="ttl"></a>234</td><td><pre>     * @param string  $key  la cl&eacute;
</pre></td></tr><tr><td class="number"><a name="ttl"></a>235</td><td><pre>     * @param integer $incr valeur
</pre></td></tr><tr><td class="number"><a name="ttl"></a>236</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="ttl"></a>237</td><td><pre>     * @throws Exception
</pre></td></tr><tr><td class="number"><a name="ttl"></a>238</td><td><pre>     * @return int
</pre></td></tr><tr><td class="number"><a name="ttl"></a>239</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="incr"></a>240</td><td><pre>    public function incr($key, $incr = 1)
</pre></td></tr><tr><td class="number"><a name="incr"></a>241</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">242</td><td><pre>        $keyP = $this-&gt;getPatternKey().$key;
</pre></td></tr><tr class="covered"><td class="number">243</td><td><pre>        $func = function ($redis) use ($keyP, $incr) {
</pre></td></tr><tr><td class="number"><a name="incr"></a>244</td><td><pre>            try {
</pre></td></tr><tr class="covered"><td class="number">245</td><td><pre>                $start = microtime(true);
</pre></td></tr><tr class="covered"><td class="number">246</td><td><pre>                $ret = $redis-&gt;incrby($keyP, $incr);
</pre></td></tr><tr class="covered"><td class="number">247</td><td><pre>                $this-&gt;notifyEvent(&#039;incrby&#039;, array($keyP, $incr), microtime(true) - $start);
</pre></td></tr><tr><td class="number"><a name="incr"></a>248</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">249</td><td><pre>                return $ret;
</pre></td></tr><tr class="covered"><td class="number">250</td><td><pre>            } catch (Predis\ServerException $e) {
</pre></td></tr><tr class="notCovered"><td class="number">251</td><td><pre>                return null;
</pre></td></tr><tr><td class="number"><a name="incr"></a>252</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">253</td><td><pre>        };
</pre></td></tr><tr><td class="number"><a name="incr"></a>254</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">255</td><td><pre>        if (true === $this-&gt;multi) {
</pre></td></tr><tr class="covered"><td class="number">256</td><td><pre>            $this-&gt;addToExecList($key, $func);
</pre></td></tr><tr><td class="number"><a name="incr"></a>257</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">258</td><td><pre>            return $this;
</pre></td></tr><tr><td class="number"><a name="incr"></a>259</td><td><pre>        } else {
</pre></td></tr><tr class="covered"><td class="number">260</td><td><pre>            if (is_null($ret = $func($this-&gt;getRedis($key)))) {
</pre></td></tr><tr class="notCovered"><td class="number">261</td><td><pre>                throw new Exception(&quot;Cant increment key &quot;.$key.&quot;, not an integer ?&quot;);
</pre></td></tr><tr><td class="number"><a name="incr"></a>262</td><td><pre>            }
</pre></td></tr><tr><td class="number"><a name="incr"></a>263</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">264</td><td><pre>            return $ret;
</pre></td></tr><tr><td class="number"><a name="incr"></a>265</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="incr"></a>266</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="incr"></a>267</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="incr"></a>268</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="incr"></a>269</td><td><pre>     * set the key ttl
</pre></td></tr><tr><td class="number"><a name="incr"></a>270</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="incr"></a>271</td><td><pre>     * @param string  $key la cl&eacute;
</pre></td></tr><tr><td class="number"><a name="incr"></a>272</td><td><pre>     * @param integer $ttl ttl en seconde
</pre></td></tr><tr><td class="number"><a name="incr"></a>273</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="incr"></a>274</td><td><pre>     * @throws Exception
</pre></td></tr><tr><td class="number"><a name="incr"></a>275</td><td><pre>     * @return int
</pre></td></tr><tr><td class="number"><a name="incr"></a>276</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="expire"></a>277</td><td><pre>    public function expire($key, $ttl)
</pre></td></tr><tr><td class="number"><a name="expire"></a>278</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">279</td><td><pre>        if ($ttl &lt;= 0) {
</pre></td></tr><tr class="covered"><td class="number">280</td><td><pre>            throw new Exception(&#039;ttl arg cant be negative&#039;);
</pre></td></tr><tr><td class="number"><a name="expire"></a>281</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="expire"></a>282</td><td><pre>
</pre></td></tr><tr class="notCovered"><td class="number">283</td><td><pre>        $keyP = $this-&gt;getPatternKey().$key;
</pre></td></tr><tr class="notCovered"><td class="number">284</td><td><pre>        $func = function ($redis) use ($keyP, $ttl) {
</pre></td></tr><tr><td class="number"><a name="expire"></a>285</td><td><pre>            try {
</pre></td></tr><tr class="notCovered"><td class="number">286</td><td><pre>                $start = microtime(true);
</pre></td></tr><tr class="notCovered"><td class="number">287</td><td><pre>                $ret = $redis-&gt;expire($keyP, $ttl);
</pre></td></tr><tr class="notCovered"><td class="number">288</td><td><pre>                $this-&gt;notifyEvent(&#039;expire&#039;, array($keyP, $ttl), microtime(true) - $start);
</pre></td></tr><tr><td class="number"><a name="expire"></a>289</td><td><pre>
</pre></td></tr><tr class="notCovered"><td class="number">290</td><td><pre>                return $ret;
</pre></td></tr><tr class="notCovered"><td class="number">291</td><td><pre>            } catch (Predis\ServerException $e) {
</pre></td></tr><tr class="notCovered"><td class="number">292</td><td><pre>                return null;
</pre></td></tr><tr><td class="number"><a name="expire"></a>293</td><td><pre>            }
</pre></td></tr><tr class="notCovered"><td class="number">294</td><td><pre>        };
</pre></td></tr><tr><td class="number"><a name="expire"></a>295</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="expire"></a>296</td><td><pre>        // gestion du multi
</pre></td></tr><tr class="notCovered"><td class="number">297</td><td><pre>        if (true === $this-&gt;multi) {
</pre></td></tr><tr class="notCovered"><td class="number">298</td><td><pre>            $this-&gt;addToExecList($key, $func);
</pre></td></tr><tr><td class="number"><a name="expire"></a>299</td><td><pre>
</pre></td></tr><tr class="notCovered"><td class="number">300</td><td><pre>            return $this;
</pre></td></tr><tr><td class="number"><a name="expire"></a>301</td><td><pre>        } else {
</pre></td></tr><tr class="notCovered"><td class="number">302</td><td><pre>            $ret = $func($this-&gt;getRedis($key));
</pre></td></tr><tr><td class="number"><a name="expire"></a>303</td><td><pre>
</pre></td></tr><tr class="notCovered"><td class="number">304</td><td><pre>            return $ret;
</pre></td></tr><tr><td class="number"><a name="expire"></a>305</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="expire"></a>306</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="expire"></a>307</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="expire"></a>308</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="expire"></a>309</td><td><pre>     * used the to build the namespace added to the keys
</pre></td></tr><tr><td class="number"><a name="expire"></a>310</td><td><pre>     * @return string
</pre></td></tr><tr><td class="number"><a name="expire"></a>311</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>312</td><td><pre>    public function getPatternKey()
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>313</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">314</td><td><pre>        return $this-&gt;namespace;
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>315</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>316</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>317</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>318</td><td><pre>     * use for debugging !
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>319</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>320</td><td><pre>     * flush all keys in the namespace
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>321</td><td><pre>     * @return integer number of deleted keys
</pre></td></tr><tr><td class="number"><a name="getPatternKey"></a>322</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="flush"></a>323</td><td><pre>    public function flush()
</pre></td></tr><tr><td class="number"><a name="flush"></a>324</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">325</td><td><pre>        $pattern = $this-&gt;getPatternKey();
</pre></td></tr><tr class="covered"><td class="number">326</td><td><pre>        $arrReturn = $this-&gt;runOnAllRedisServer(
</pre></td></tr><tr class="covered"><td class="number">327</td><td><pre>            function ($redis) use ($pattern) {
</pre></td></tr><tr class="covered"><td class="number">328</td><td><pre>                $wasDeleted = 0;
</pre></td></tr><tr class="covered"><td class="number">329</td><td><pre>                $allKeys = $redis-&gt;keys($pattern.&#039;*&#039;); // all keys started with the namespace
</pre></td></tr><tr class="covered"><td class="number">330</td><td><pre>                if (count($allKeys)) {
</pre></td></tr><tr class="covered"><td class="number">331</td><td><pre>                    $wasDeleted = $redis-&gt;del($allKeys);
</pre></td></tr><tr class="covered"><td class="number">332</td><td><pre>                }
</pre></td></tr><tr><td class="number"><a name="flush"></a>333</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">334</td><td><pre>                return array($wasDeleted);
</pre></td></tr><tr><td class="number"><a name="flush"></a>335</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">336</td><td><pre>        );
</pre></td></tr><tr><td class="number"><a name="flush"></a>337</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">338</td><td><pre>        return array_sum($arrReturn);
</pre></td></tr><tr><td class="number"><a name="flush"></a>339</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="flush"></a>340</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="flush"></a>341</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="flush"></a>342</td><td><pre>     * watch
</pre></td></tr><tr><td class="number"><a name="flush"></a>343</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="flush"></a>344</td><td><pre>     * @param string $key cl&eacute;
</pre></td></tr><tr><td class="number"><a name="flush"></a>345</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="flush"></a>346</td><td><pre>     * @return void
</pre></td></tr><tr><td class="number"><a name="flush"></a>347</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="watch"></a>348</td><td><pre>    public function watch($key)
</pre></td></tr><tr><td class="number"><a name="watch"></a>349</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">350</td><td><pre>        $redis = $this-&gt;getRedis($key);
</pre></td></tr><tr class="covered"><td class="number">351</td><td><pre>        $this-&gt;notifyEvent(&#039;watch&#039;, array($this-&gt;getPatternKey().$key));
</pre></td></tr><tr class="covered"><td class="number">352</td><td><pre>        $redis-&gt;watch($this-&gt;getPatternKey().$key);
</pre></td></tr><tr class="covered"><td class="number">353</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="watch"></a>354</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="watch"></a>355</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="watch"></a>356</td><td><pre>     * unwatch (flush all params watched)
</pre></td></tr><tr><td class="number"><a name="watch"></a>357</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="watch"></a>358</td><td><pre>     * @return string
</pre></td></tr><tr><td class="number"><a name="watch"></a>359</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>360</td><td><pre>    public function unwatch()
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>361</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">362</td><td><pre>        return $this-&gt;runOnAllRedisServer(
</pre></td></tr><tr class="covered"><td class="number">363</td><td><pre>            function ($redis) {
</pre></td></tr><tr class="covered"><td class="number">364</td><td><pre>                $this-&gt;notifyEvent(&#039;unwatch&#039;, array());
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>365</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">366</td><td><pre>                return $redis-&gt;unwatch();
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>367</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">368</td><td><pre>        );
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>369</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>370</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>371</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>372</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>373</td><td><pre>     * allow a transactionnal execution
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>374</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>375</td><td><pre>     * @return Cache
</pre></td></tr><tr><td class="number"><a name="unwatch"></a>376</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="multi"></a>377</td><td><pre>    public function multi()
</pre></td></tr><tr><td class="number"><a name="multi"></a>378</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">379</td><td><pre>        $this-&gt;multi = true;
</pre></td></tr><tr class="covered"><td class="number">380</td><td><pre>        $this-&gt;execList = array(); // purge the execList
</pre></td></tr><tr><td class="number"><a name="multi"></a>381</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">382</td><td><pre>        return $this;
</pre></td></tr><tr><td class="number"><a name="multi"></a>383</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="multi"></a>384</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="multi"></a>385</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="multi"></a>386</td><td><pre>     * execute multiple commands
</pre></td></tr><tr><td class="number"><a name="multi"></a>387</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="multi"></a>388</td><td><pre>     * @throws Exception
</pre></td></tr><tr><td class="number"><a name="multi"></a>389</td><td><pre>     * @return array outputs of the commands
</pre></td></tr><tr><td class="number"><a name="multi"></a>390</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="exec"></a>391</td><td><pre>    public function exec()
</pre></td></tr><tr><td class="number"><a name="exec"></a>392</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">393</td><td><pre>        if (true === $this-&gt;multi) {
</pre></td></tr><tr class="covered"><td class="number">394</td><td><pre>            $ret         = array();
</pre></td></tr><tr class="covered"><td class="number">395</td><td><pre>            $this-&gt;multi = false;
</pre></td></tr><tr><td class="number"><a name="exec"></a>396</td><td><pre>            // exec
</pre></td></tr><tr class="covered"><td class="number">397</td><td><pre>            foreach ($this-&gt;execList as $todos) {
</pre></td></tr><tr class="covered"><td class="number">398</td><td><pre>                $redis = $todos[0][&#039;redis&#039;]; // ^^ not so secure ?
</pre></td></tr><tr class="covered"><td class="number">399</td><td><pre>                $this-&gt;notifyEvent(&#039;multi&#039;, array());
</pre></td></tr><tr class="covered"><td class="number">400</td><td><pre>                $redis-&gt;multi();
</pre></td></tr><tr class="covered"><td class="number">401</td><td><pre>                foreach ($todos as $todo) {
</pre></td></tr><tr class="covered"><td class="number">402</td><td><pre>                    if ($todo[&#039;function&#039;] instanceof \Closure) {
</pre></td></tr><tr class="covered"><td class="number">403</td><td><pre>                        $ret[] = $todo[&#039;function&#039;]($redis);
</pre></td></tr><tr class="covered"><td class="number">404</td><td><pre>                    } else {
</pre></td></tr><tr class="notCovered"><td class="number">405</td><td><pre>                        throw new Exception(&quot;Ce n&#039;est pas une Closure !&quot;);
</pre></td></tr><tr><td class="number"><a name="exec"></a>406</td><td><pre>                    }
</pre></td></tr><tr class="covered"><td class="number">407</td><td><pre>                }
</pre></td></tr><tr class="covered"><td class="number">408</td><td><pre>                $this-&gt;notifyEvent(&#039;exec&#039;, array());
</pre></td></tr><tr class="covered"><td class="number">409</td><td><pre>                $redis-&gt;exec();
</pre></td></tr><tr class="covered"><td class="number">410</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">411</td><td><pre>            $this-&gt;execList = array(); // purge the execList
</pre></td></tr><tr><td class="number"><a name="exec"></a>412</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">413</td><td><pre>            return $ret;
</pre></td></tr><tr><td class="number"><a name="exec"></a>414</td><td><pre>        } else {
</pre></td></tr><tr class="covered"><td class="number">415</td><td><pre>            throw new Exception(&quot;you have to call multi before exec&quot;);
</pre></td></tr><tr><td class="number"><a name="exec"></a>416</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="exec"></a>417</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="exec"></a>418</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="exec"></a>419</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="exec"></a>420</td><td><pre>     * cancel a transaction
</pre></td></tr><tr><td class="number"><a name="exec"></a>421</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="exec"></a>422</td><td><pre>     * @return Cache
</pre></td></tr><tr><td class="number"><a name="exec"></a>423</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="discard"></a>424</td><td><pre>    public function discard()
</pre></td></tr><tr><td class="number"><a name="discard"></a>425</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">426</td><td><pre>        $this-&gt;multi    = false;
</pre></td></tr><tr class="covered"><td class="number">427</td><td><pre>        $this-&gt;execList = array(); // purge the execList
</pre></td></tr><tr><td class="number"><a name="discard"></a>428</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">429</td><td><pre>        return $this;
</pre></td></tr><tr><td class="number"><a name="discard"></a>430</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="discard"></a>431</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="discard"></a>432</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="discard"></a>433</td><td><pre>     * return an array of server with all the keys stored in the cache
</pre></td></tr><tr><td class="number"><a name="discard"></a>434</td><td><pre>     * use only for debug
</pre></td></tr><tr><td class="number"><a name="discard"></a>435</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="discard"></a>436</td><td><pre>     * @return array
</pre></td></tr><tr><td class="number"><a name="discard"></a>437</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>438</td><td><pre>    public function getAllKeys()
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>439</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">440</td><td><pre>        $pattern = $this-&gt;getPatternKey();
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>441</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">442</td><td><pre>        return $this-&gt;runOnAllRedisServer(
</pre></td></tr><tr class="covered"><td class="number">443</td><td><pre>            function ($redis) use ($pattern) {
</pre></td></tr><tr class="covered"><td class="number">444</td><td><pre>                $this-&gt;notifyEvent(&#039;keys&#039;, array($pattern.&#039;*&#039;));
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>445</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">446</td><td><pre>                return $redis-&gt;keys($pattern.&#039;*&#039;); // toutes les cl&eacute;s commen&ccedil;ant par le pattern
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>447</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">448</td><td><pre>        );
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>449</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>450</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>451</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>452</td><td><pre>     * return an array of server with all the keys stored in the cache according to $pattern
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>453</td><td><pre>     * use only for debug
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>454</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>455</td><td><pre>     * @param string $pattern the pattern - ie : raoul*
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>456</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>457</td><td><pre>     * @return array
</pre></td></tr><tr><td class="number"><a name="getAllKeys"></a>458</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="keys"></a>459</td><td><pre>    public function keys($pattern)
</pre></td></tr><tr><td class="number"><a name="keys"></a>460</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">461</td><td><pre>        $pattern = $this-&gt;getPatternKey().$pattern;
</pre></td></tr><tr><td class="number"><a name="keys"></a>462</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">463</td><td><pre>        return $this-&gt;runOnAllRedisServer(
</pre></td></tr><tr class="covered"><td class="number">464</td><td><pre>            function ($redis) use ($pattern) {
</pre></td></tr><tr class="covered"><td class="number">465</td><td><pre>                $this-&gt;notifyEvent(&#039;keys&#039;, array($pattern));
</pre></td></tr><tr><td class="number"><a name="keys"></a>466</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">467</td><td><pre>                return $redis-&gt;keys($pattern);
</pre></td></tr><tr><td class="number"><a name="keys"></a>468</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">469</td><td><pre>        );
</pre></td></tr><tr><td class="number"><a name="keys"></a>470</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="keys"></a>471</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="keys"></a>472</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="keys"></a>473</td><td><pre>     * apply a Closure on all the servers
</pre></td></tr><tr><td class="number"><a name="keys"></a>474</td><td><pre>     * @param \Closure $func anonymous function
</pre></td></tr><tr><td class="number"><a name="keys"></a>475</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="keys"></a>476</td><td><pre>     * @return array array of results returned bye redis commands
</pre></td></tr><tr><td class="number"><a name="keys"></a>477</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>478</td><td><pre>    protected function runOnAllRedisServer(\Closure $func)
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>479</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">480</td><td><pre>        $ret = array();
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>481</td><td><pre>        // loop on all servers
</pre></td></tr><tr class="covered"><td class="number">482</td><td><pre>        foreach (array_keys($this-&gt;getServerConfig()) as $serverId) {
</pre></td></tr><tr class="covered"><td class="number">483</td><td><pre>            if ($redis = $this-&gt;getRedisFromServerConfig($serverId)) {
</pre></td></tr><tr class="covered"><td class="number">484</td><td><pre>                $retFunc = $func($redis);
</pre></td></tr><tr class="covered"><td class="number">485</td><td><pre>                if (is_array($retFunc)) {
</pre></td></tr><tr class="covered"><td class="number">486</td><td><pre>                    $ret = array_merge($ret, $retFunc);
</pre></td></tr><tr class="covered"><td class="number">487</td><td><pre>                }
</pre></td></tr><tr class="covered"><td class="number">488</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">489</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>490</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">491</td><td><pre>        return $ret;
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>492</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>493</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>494</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>495</td><td><pre>     * return an array or server with the number of keys stored on each
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>496</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>497</td><td><pre>     * @param string $idServer Id du server
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>498</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>499</td><td><pre>     * @return array / integer
</pre></td></tr><tr><td class="number"><a name="runOnAllRedisServer"></a>500</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>501</td><td><pre>    public function dbSize($idServer = null)
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>502</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">503</td><td><pre>        if (is_null($idServer)) {
</pre></td></tr><tr class="covered"><td class="number">504</td><td><pre>            $servers = $this-&gt;getServerConfig();
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>505</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">506</td><td><pre>            $dbsize = array();
</pre></td></tr><tr class="covered"><td class="number">507</td><td><pre>            foreach (array_keys($servers) as $idServer) {
</pre></td></tr><tr class="covered"><td class="number">508</td><td><pre>                $redis = $this-&gt;getRedisFromServerConfig($idServer);
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>509</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">510</td><td><pre>                $dbsize[$idServer] = $redis-&gt;dbsize();
</pre></td></tr><tr class="covered"><td class="number">511</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">512</td><td><pre>        } else {
</pre></td></tr><tr class="notCovered"><td class="number">513</td><td><pre>            $redis = $this-&gt;getRedisFromServerConfig($idServer);
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>514</td><td><pre>
</pre></td></tr><tr class="notCovered"><td class="number">515</td><td><pre>            $dbsize = $redis-&gt;dbsize();
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>516</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>517</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">518</td><td><pre>        return $dbsize;
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>519</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>520</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>521</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>522</td><td><pre>     * return info of a server or all
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>523</td><td><pre>     * @param string $idServer Id du server
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>524</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>525</td><td><pre>     * @return mixed
</pre></td></tr><tr><td class="number"><a name="dbSize"></a>526</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="info"></a>527</td><td><pre>    public function info($idServer = null)
</pre></td></tr><tr><td class="number"><a name="info"></a>528</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">529</td><td><pre>        if (is_null($idServer)) {
</pre></td></tr><tr class="covered"><td class="number">530</td><td><pre>            $servers = $this-&gt;getServerConfig();
</pre></td></tr><tr><td class="number"><a name="info"></a>531</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">532</td><td><pre>            $info = array();
</pre></td></tr><tr class="covered"><td class="number">533</td><td><pre>            foreach (array_keys($servers) as $idServer) {
</pre></td></tr><tr class="covered"><td class="number">534</td><td><pre>                $redis = $this-&gt;getRedisFromServerConfig($idServer);
</pre></td></tr><tr><td class="number"><a name="info"></a>535</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">536</td><td><pre>                $info[$idServer] = $redis-&gt;info();
</pre></td></tr><tr class="covered"><td class="number">537</td><td><pre>            }
</pre></td></tr><tr class="covered"><td class="number">538</td><td><pre>        } else {
</pre></td></tr><tr class="notCovered"><td class="number">539</td><td><pre>            $redis = $this-&gt;getRedisFromServerConfig($idServer);
</pre></td></tr><tr><td class="number"><a name="info"></a>540</td><td><pre>
</pre></td></tr><tr class="notCovered"><td class="number">541</td><td><pre>            $info = $redis-&gt;info();
</pre></td></tr><tr><td class="number"><a name="info"></a>542</td><td><pre>        }
</pre></td></tr><tr><td class="number"><a name="info"></a>543</td><td><pre>
</pre></td></tr><tr class="covered"><td class="number">544</td><td><pre>        return $info;
</pre></td></tr><tr><td class="number"><a name="info"></a>545</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="info"></a>546</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="info"></a>547</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="info"></a>548</td><td><pre>     * method not allowed in cache mode
</pre></td></tr><tr><td class="number"><a name="info"></a>549</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="info"></a>550</td><td><pre>     * @param string $v de toute fa&ccedil;on j&#039;m&#039;en fiche
</pre></td></tr><tr><td class="number"><a name="info"></a>551</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="info"></a>552</td><td><pre>     * @deprecated
</pre></td></tr><tr><td class="number"><a name="info"></a>553</td><td><pre>     * @return object|void
</pre></td></tr><tr><td class="number"><a name="info"></a>554</td><td><pre>     * @throws Exception
</pre></td></tr><tr><td class="number"><a name="info"></a>555</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>556</td><td><pre>    public function setCurrentDb($v)
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>557</td><td><pre>    {
</pre></td></tr><tr class="notCovered"><td class="number">558</td><td><pre>        throw new Exception(&quot;forbidden method in cache mode :&quot;.__METHOD__);
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>559</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>560</td><td><pre>
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>561</td><td><pre>    /**
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>562</td><td><pre>     * add a task to the execution list
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>563</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>564</td><td><pre>     * @param string   $key  cl&eacute;
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>565</td><td><pre>     * @param callable $func closure &agrave; ajouter
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>566</td><td><pre>     *
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>567</td><td><pre>     * @return void
</pre></td></tr><tr><td class="number"><a name="setCurrentDb"></a>568</td><td><pre>     */
</pre></td></tr><tr><td class="number"><a name="addToExecList"></a>569</td><td><pre>    protected function addToExecList($key, \Closure $func)
</pre></td></tr><tr><td class="number"><a name="addToExecList"></a>570</td><td><pre>    {
</pre></td></tr><tr class="covered"><td class="number">571</td><td><pre>        $redis = $this-&gt;getRedis($key);
</pre></td></tr><tr class="covered"><td class="number">572</td><td><pre>        $this-&gt;execList[md5(serialize($redis))][] = array(
</pre></td></tr><tr class="covered"><td class="number">573</td><td><pre>            &#039;key&#039;      =&gt; $key,
</pre></td></tr><tr class="covered"><td class="number">574</td><td><pre>            &#039;function&#039; =&gt; $func,
</pre></td></tr><tr><td class="number"><a name="addToExecList"></a>575</td><td><pre>            &#039;redis&#039;    =&gt; $redis
</pre></td></tr><tr class="covered"><td class="number">576</td><td><pre>        );
</pre></td></tr><tr class="covered"><td class="number">577</td><td><pre>    }
</pre></td></tr><tr><td class="number"><a name="addToExecList"></a>578</td><td><pre>}
</pre></td></tr>
				</table>
			</div>
		</div>
		<div id="footer">
			<p>Code coverage report powered by <a href="http://atoum.org">atoum</a></p>
		</div>
	</body>
</html>
